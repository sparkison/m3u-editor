server {
    listen ${XTREAM_PORT};
    server_name _;

    # ========= ALLOWED ENDPOINTS =========
    # Xtream API only - strict playlist/EPG endpoints

    location = /player_api.php {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    location = /xmltv.php {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    location /get.php {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    location ~ "^/logo-proxy/[A-Za-z0-9_-]+$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # /USER/UUID/<name>
    # required for xtream
    location ~ "^/[A-Za-z0-9_-]+/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/[A-Za-z0-9_-]+$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # ========= STRICT EPG REDIRECT =========
    ### STRICT EPG ###
    # /UUID/epg.xml
    location ~ "^/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/epg\.(xml|xml\.gz)$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # /UUID/playlist.m3u
    location ~ "^/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/[A-Za-z0-9_-]+\.(m3u8?|m3u)$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    ### LIVE STREAMS / MOVIES / SERIES - ANY EXTENSION ###
    # /live/USER/UUID/<filename>.<any_extension>
    # /movie/USER/UUID/<filename>.<any_extension>
    # /series/USER/UUID/<filename>.<any_extension>
    # Supports: .m3u8, .m3u, .ts, .mp4, .mkv, .avi, etc.
    location ~ "^/(live|movie|series)/[A-Za-z0-9_-]+/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/[A-Za-z0-9_.-]+$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    ### TIMESHIFT STREAMS ###
    # /timeshift/USER/UUID/DURATION/DATE/<filename>.<any_extension>
    location ~ "^/timeshift/[A-Za-z0-9_-]+/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/[^/]+/[^/]+/[A-Za-z0-9_.-]+$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    ### SCHEDULES DIRECT IMAGE PROXY ###
    # /schedules-direct/<epg>/image/<imageHash>
    location ~ "^/schedules-direct/[A-Za-z0-9_-]+/image/[A-Za-z0-9_-]+$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    ### M3U-PROXY DEFAULT HLS STREAMS - ANY EXTENSION ###
    # /m3u-proxy/hls/<hash>/playlist.m3u8
    location ~ "^/m3u-proxy/hls/[A-Za-z0-9-]+/playlist.m3u8+$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    ### M3U-PROXY DEFAULT MPEG-TS STREAMS - ANY EXTENSION ###
    # /m3u-proxy/hls/<hash>
    location ~ "^/m3u-proxy/stream/[A-Za-z0-9-]+$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # ========= BLOCK EVERYTHING ELSE =========

    location / {
      return 404;
    }
}