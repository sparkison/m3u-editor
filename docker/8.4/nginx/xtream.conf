server {
    listen ${XTREAM_PORT};
    server_name _;

    # ========= ALLOWED ENDPOINTS =========
    # Xtream API only - strict playlist/EPG endpoints

    location = /player_api.php {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    location = /xmltv.php {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    location /get.php {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    location ~ "^/logo-proxy/[A-Za-z0-9_-]+$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # /USER/UUID/<name>
    # required for xtream
    location ~ "^/[A-Za-z0-9_-]+/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/[A-Za-z0-9_-]+$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # ========= STRICT EPG REDIRECT =========
    ### STRICT EPG ###
    # /UUID/epg.xml
    location ~ "^/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/epg\.(xml|xml\.gz)$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # /UUID/playlist.m3u
    location ~ "^/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/[A-Za-z0-9_-]+\.(m3u8?|m3u)$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    ### STRICT PLAYLIST (.m3u8) ###
    # /live/USER/UUID/<name>.m3u8 or .m3u
    location ~ "^/live/[A-Za-z0-9_-]+/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/[A-Za-z0-9_-]+\.(m3u8?|m3u)$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    ### STRICT TS SEGMENTS ###
    # /live/admin/UUID/12345.ts
    location ~ "^/live/[A-Za-z0-9_-]+/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/[0-9]+\.ts$" {
      proxy_pass http://127.0.0.1:${APP_PORT};
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # ========= BLOCK EVERYTHING ELSE =========

    location / {
      return 404;
    }
}