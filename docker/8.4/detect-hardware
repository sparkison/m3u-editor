#!/usr/bin/env bash

# Hardware Detection Script for m3u-editor/m3u-proxy
# Detects GPU hardware, drivers, and FFmpeg capabilities
# Outputs detailed logs with emojis and status indicators

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Emojis
CHECK="âœ…"
CROSS="âŒ"
INFO="â„¹ï¸"
SEARCH="ğŸ”"
GEAR="ğŸ”°"
WARN="âš ï¸"

echo ""
echo "${SEARCH} Running hardware acceleration check..."
echo ""

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to detect GPU
detect_gpu() {
    echo "${SEARCH} Checking for GPU acceleration devices..."

    local gpu_info=""

    # Try lspci first
    if command_exists lspci; then
        gpu_info=$(lspci 2>/dev/null | grep -i 'vga\|3d\|display' | head -n 1 || true)
    fi

    # Fallback to /sys if lspci not available
    if [ -z "$gpu_info" ]; then
        if [ -d "/sys/class/drm/card0/device" ]; then
            local vendor=$(cat /sys/class/drm/card0/device/vendor 2>/dev/null || echo "")
            local device=$(cat /sys/class/drm/card0/device/device 2>/dev/null || echo "")

            case "$vendor" in
                "0x8086") gpu_info="Intel GPU (Vendor: $vendor, Device: $device)" ;;
                "0x1002") gpu_info="AMD GPU (Vendor: $vendor, Device: $device)" ;;
                "0x10de") gpu_info="NVIDIA GPU (Vendor: $vendor, Device: $device)" ;;
                *) gpu_info="Unknown GPU (Vendor: $vendor, Device: $device)" ;;
            esac
        fi
    fi

    if [ -n "$gpu_info" ]; then
        echo "${SEARCH} Hardware detection: $gpu_info"
        GPU_DETECTED="$gpu_info"
    else
        echo "${INFO} No GPU detected via lspci or /sys"
        GPU_DETECTED="None"
    fi

    echo ""
}

# Function to check DRI devices
check_dri_devices() {
    echo "${SEARCH} Checking for VAAPI device nodes (Intel/AMD)..."

    local dri_accessible=0
    local dri_total=0
    local has_render=false

    # Check for renderD* devices
    for device in /dev/dri/renderD*; do
        if [ -e "$device" ]; then
            dri_total=$((dri_total + 1))
            if [ -r "$device" ] && [ -w "$device" ]; then
                echo "${CHECK} Device $device is accessible."
                dri_accessible=$((dri_accessible + 1))
                has_render=true
            else
                echo "${WARN} Device $device exists but is not accessible."
            fi
        fi
    done

    # Check for card* devices
    for device in /dev/dri/card*; do
        if [ -e "$device" ]; then
            dri_total=$((dri_total + 1))
            if [ -r "$device" ]; then
                echo "${CHECK} Device $device is accessible."
                dri_accessible=$((dri_accessible + 1))
            else
                echo "${WARN} Device $device exists but is not accessible."
            fi
        fi
    done

    if [ $dri_total -eq 0 ]; then
        echo "${INFO} No DRI device nodes found under /dev/dri."
        DRI_STATUS="NOT_FOUND"
    elif [ $dri_accessible -eq $dri_total ]; then
        echo "${CHECK} User $(whoami) has access to all DRI devices ($dri_accessible/$dri_total)"
        if [ "$has_render" = true ]; then
            echo "   VAAPI hardware acceleration should work properly."
        fi
        DRI_STATUS="FULL_ACCESS"
        DRI_COUNT="$dri_accessible/$dri_total"
    else
        echo "${WARN} User $(whoami) has partial access to DRI devices ($dri_accessible/$dri_total)"
        DRI_STATUS="PARTIAL_ACCESS"
        DRI_COUNT="$dri_accessible/$dri_total"
    fi

    echo ""
}

# Function to check NVIDIA devices
check_nvidia_devices() {
    echo "${SEARCH} Checking for NVIDIA device nodes..."

    if [ -e "/dev/nvidia0" ] || [ -e "/dev/nvidiactl" ]; then
        echo "${CHECK} NVIDIA device nodes found."
        NVIDIA_STATUS="FOUND"
    else
        echo "${INFO} No NVIDIA device nodes found under /dev."
        NVIDIA_STATUS="NOT_FOUND"
    fi

    echo ""
}



# Function to check user groups
check_user_groups() {
    echo "${SEARCH} Checking user group memberships and device access..."

    local current_user=$(whoami)
    local user_groups=$(groups 2>/dev/null || echo "")

    # Check for video group
    if echo "$user_groups" | grep -q "video"; then
        local video_gid=$(getent group video | cut -d: -f3 2>/dev/null || echo "unknown")
        echo "${INFO} User $current_user is in the 'video' group (GID $video_gid)."
        VIDEO_GROUP="YES"
    else
        echo "${INFO} User $current_user is NOT in the 'video' group."
        VIDEO_GROUP="NO"
    fi

    # Check for render group
    if echo "$user_groups" | grep -q "render"; then
        local render_gid=$(getent group render | cut -d: -f3 2>/dev/null || echo "unknown")
        echo "${INFO} User $current_user is in the 'render' group (GID $render_gid)."
        RENDER_GROUP="YES"
    else
        echo "${INFO} User $current_user is NOT in the 'render' group."
        RENDER_GROUP="NO"
    fi

    # Check device access for primary renderD128
    if [ -e "/dev/dri/renderD128" ]; then
        if [ -r "/dev/dri/renderD128" ] && [ -w "/dev/dri/renderD128" ]; then
            echo "${CHECK} User $current_user has full access to /dev/dri/renderD128"
            RENDER_ACCESS="FULL"
        elif [ -r "/dev/dri/renderD128" ]; then
            echo "${WARN} User $current_user has read-only access to /dev/dri/renderD128"
            RENDER_ACCESS="READ_ONLY"
        else
            echo "${CROSS} User $current_user has NO access to /dev/dri/renderD128"
            RENDER_ACCESS="NONE"
        fi
    fi

    echo ""
}

# Function to check FFmpeg hardware acceleration
check_ffmpeg_hwaccel() {
    echo "${SEARCH} Checking FFmpeg hardware acceleration capabilities..."

    if ! command_exists ffmpeg; then
        echo "${CROSS} FFmpeg not found in PATH"
        FFMPEG_STATUS="NOT_FOUND"
        echo ""
        return
    fi

    # Get FFmpeg version
    local ffmpeg_version=$(ffmpeg -version 2>/dev/null | head -n 1 || echo "Unknown")
    echo "${INFO} FFmpeg version: $ffmpeg_version"

    # Get available hwaccel methods
    local hwaccels=$(ffmpeg -hwaccels 2>/dev/null | tail -n +2 || echo "")

    if [ -z "$hwaccels" ]; then
        echo "${CROSS} Could not detect FFmpeg hardware acceleration methods"
        FFMPEG_STATUS="ERROR"
        echo ""
        return
    fi

    echo ""
    echo "${SEARCH} Available FFmpeg hardware acceleration methods:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # Categorize hwaccel methods
    local compatible_methods=""
    local other_methods=""

    # Determine compatible methods based on detected GPU
    local is_intel=false
    local is_amd=false
    local is_nvidia=false

    if echo "$GPU_DETECTED" | grep -qi "intel"; then
        is_intel=true
    fi
    if echo "$GPU_DETECTED" | grep -qi "amd"; then
        is_amd=true
    fi
    if echo "$GPU_DETECTED" | grep -qi "nvidia"; then
        is_nvidia=true
    fi

    # Check each hwaccel method
    while IFS= read -r method; do
        method=$(echo "$method" | xargs) # trim whitespace
        [ -z "$method" ] && continue

        local is_compatible=false
        local description=""

        case "$method" in
            vaapi)
                if [ "$is_intel" = true ] || [ "$is_amd" = true ]; then
                    is_compatible=true
                    if [ "$is_intel" = true ]; then
                        description="Intel VAAPI acceleration"
                    else
                        description="AMD VAAPI acceleration"
                    fi
                fi
                ;;
            qsv)
                if [ "$is_intel" = true ]; then
                    is_compatible=true
                    description="Intel QuickSync acceleration"
                fi
                ;;
            cuda|nvdec|nvenc)
                if [ "$is_nvidia" = true ]; then
                    is_compatible=true
                    description="NVIDIA CUDA acceleration"
                fi
                ;;
        esac

        if [ "$is_compatible" = true ]; then
            compatible_methods="${compatible_methods}${method},"
            echo "  ${CHECK} $method - $description"
        else
            other_methods="${other_methods}${method},"
        fi
    done <<< "$hwaccels"

    # Show other methods
    if [ -n "$other_methods" ]; then
        echo "  ${INFO} Other available methods (not compatible with detected hardware):"
        IFS=',' read -ra METHODS <<< "$other_methods"
        for method in "${METHODS[@]}"; do
            [ -z "$method" ] && continue
            echo "    ${INFO} $method"
        done
    fi

    FFMPEG_HWACCELS="$compatible_methods"
    FFMPEG_STATUS="OK"

    echo ""
}

# Function to print summary
print_summary() {
    echo "ğŸ“‹ ===================== SUMMARY ====================="

    # GPU Info
    if [ "$GPU_DETECTED" != "None" ]; then
        echo "${GEAR} GPU: $GPU_DETECTED"
    else
        echo "${INFO} GPU: Not detected"
    fi

    # DRI Device Access
    if [ "$DRI_STATUS" = "FULL_ACCESS" ]; then
        echo "${CHECK} Device access: ALL DRI DEVICES ACCESSIBLE ($DRI_COUNT)"
        echo "   VAAPI hardware acceleration should work properly."
    elif [ "$DRI_STATUS" = "PARTIAL_ACCESS" ]; then
        echo "${WARN} Device access: PARTIAL DRI ACCESS ($DRI_COUNT)"
        echo "   Some hardware acceleration features may not work."
    elif [ "$DRI_STATUS" = "NOT_FOUND" ]; then
        echo "${CROSS} Device access: NO DRI DEVICES FOUND"
        echo "   Hardware acceleration NOT available."
        echo "   ${INFO} To enable: Add '--device=/dev/dri:/dev/dri' to docker run command"
    fi

    # FFmpeg Status
    if [ "$FFMPEG_STATUS" = "OK" ] && [ -n "$FFMPEG_HWACCELS" ]; then
        IFS=',' read -ra METHODS <<< "$FFMPEG_HWACCELS"
        for method in "${METHODS[@]}"; do
            [ -z "$method" ] && continue

            case "$method" in
                vaapi)
                    echo "${CHECK} FFmpeg VAAPI acceleration: AVAILABLE"
                    echo "   Recommended for: General video transcoding with Intel/AMD GPUs"
                    ;;
                qsv)
                    echo "${CHECK} FFmpeg QSV acceleration: AVAILABLE"
                    echo "   Recommended for: High-performance Intel QuickSync transcoding"
                    ;;
                cuda|nvdec)
                    echo "${CHECK} FFmpeg NVIDIA acceleration: AVAILABLE"
                    echo "   Recommended for: NVIDIA GPU transcoding"
                    ;;
            esac
        done
    elif [ "$FFMPEG_STATUS" = "NOT_FOUND" ]; then
        echo "${CROSS} FFmpeg: NOT FOUND"
    else
        echo "${INFO} FFmpeg: No compatible hardware acceleration detected"
    fi

    echo "ğŸ“‹ =================================================="
    echo ""
}

# Main execution
GPU_DETECTED="None"
DRI_STATUS="NOT_FOUND"
DRI_COUNT="0/0"
NVIDIA_STATUS="NOT_FOUND"
VIDEO_GROUP="NO"
RENDER_GROUP="NO"
RENDER_ACCESS="NONE"
FFMPEG_STATUS="NOT_FOUND"
FFMPEG_HWACCELS=""

detect_gpu
check_dri_devices
check_nvidia_devices
check_user_groups
check_ffmpeg_hwaccel
print_summary

echo "${CHECK} GPU detection script complete."
echo ""
