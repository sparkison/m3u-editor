# HLS Playback Failure - Root Cause Analysis

## üî¥ **CRITICAL ISSUE IDENTIFIED**

**Symptom:** HLS streams load (player displays), segments are written to `/dev/shm`, but no video/audio plays - just black screen with loading spinner.

**Root Cause:** **Segment URL path mismatch** - m3u-proxy is rewriting segment URLs with incorrect file paths that don't match the actual location where segments are stored.

---

## üìä **Complete Data Flow Analysis**

### **1. FFmpeg Writes Segments to Disk**

**Location:** `pooled_stream_manager.py` lines 83-99

```python
# Creates HLS directory using HLS_TEMP_DIR setting
self.hls_dir = tempfile.mkdtemp(prefix=f"m3u_proxy_hls_{stream_id}_", dir=base_dir)
# Example: /hls_temp/m3u_proxy_hls_abc123_xyz/
```

**FFmpeg Command (line 148):**

```python
playlist_path = os.path.join(self.hls_dir, 'index.m3u8')
# Example: /hls_temp/m3u_proxy_hls_abc123_xyz/index.m3u8
```

**Result:** FFmpeg writes:

-   `/hls_temp/m3u_proxy_hls_abc123_xyz/index.m3u8` (playlist)
-   `/hls_temp/m3u_proxy_hls_abc123_xyz/segment_000.ts` (segments)
-   `/hls_temp/m3u_proxy_hls_abc123_xyz/segment_001.ts`
-   etc.

‚úÖ **This part works correctly** - segments ARE being written to `/dev/shm` on your host.

---

### **2. m3u-proxy Reads Playlist from Disk**

**Location:** `pooled_stream_manager.py` lines 345-356

```python
async def read_playlist(self) -> Optional[str]:
    """Read the generated HLS playlist (index.m3u8) if available"""
    playlist_path = os.path.join(self.hls_dir, 'index.m3u8')
    if os.path.exists(playlist_path):
        with open(playlist_path, 'r') as fh:
            return fh.read()
```

**Raw Playlist Content (from FFmpeg):**

```m3u8
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:10
#EXTINF:10.0,
segment_000.ts
#EXTINF:10.0,
segment_001.ts
```

‚úÖ **This part works correctly** - playlist is read successfully.

---

### **3. M3U8Processor Rewrites Segment URLs**

**Location:** `stream_manager.py` lines 1440-1466

```python
# Construct pseudo-final URL based on local file path
final_url = f"file://{shared_process.hls_dir}/index.m3u8"
# Example: file:///hls_temp/m3u_proxy_hls_abc123_xyz/index.m3u8

# M3U8 library resolves relative segment URLs to absolute
# segment_000.ts ‚Üí file:///hls_temp/m3u_proxy_hls_abc123_xyz/segment_000.ts

processor = M3U8Processor(base_proxy_url, client_id, ...)
processed_content = processor.process_playlist(playlist_text, base_proxy_url, base_url)
```

**Location:** `stream_manager.py` lines 144-152

```python
def _rewrite_url(self, original_url: str, base_proxy_url: str) -> str:
    """Rewrites a URL to point to the proxy, encoding the original URL."""
    encoded_url = quote(original_url, safe='')
    if original_url.endswith('.m3u8'):
        return f"{base_proxy_url}/playlist.m3u8?url={encoded_url}&client_id={self.client_id}"
    else:
        return f"{base_proxy_url}/segment.ts?url={encoded_url}&client_id={self.client_id}"
```

**Rewritten Playlist Sent to Client:**

```m3u8
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:10
#EXTINF:10.0,
http://yourip/m3u-proxy/hls/abc123/segment.ts?url=file%3A%2F%2F%2Fhls_temp%2Fm3u_proxy_hls_abc123_xyz%2Fsegment_000.ts&client_id=xyz
#EXTINF:10.0,
http://yourip/m3u-proxy/hls/abc123/segment.ts?url=file%3A%2F%2F%2Fhls_temp%2Fm3u_proxy_hls_abc123_xyz%2Fsegment_001.ts&client_id=xyz
```

‚úÖ **This part works correctly** - URLs are rewritten to proxy endpoints.

---

### **4. Client Requests Segment from m3u-proxy**

**Client Request:**

```
GET /m3u-proxy/hls/abc123/segment.ts?url=file%3A%2F%2F%2Fhls_temp%2Fm3u_proxy_hls_abc123_xyz%2Fsegment_000.ts&client_id=xyz
```

**NGINX Routing:** `docker/8.4/nginx/laravel.conf` lines 50-61

```nginx
location /m3u-proxy/ {
    proxy_pass http://${M3U_PROXY_NGINX_TARGET};
    # Forwards to m3u-proxy FastAPI service
}
```

**m3u-proxy Endpoint:** `api.py` line 749

```python
@app.get("/hls/{stream_id}/segment")
async def get_hls_segment(stream_id: str, url: str = Query(...)):
    segment_url = unquote(url)
    # segment_url = "file:///hls_temp/m3u_proxy_hls_abc123_xyz/segment_000.ts"

    response = await stream_manager.proxy_hls_segment(stream_id, client_id, segment_url, ...)
```

**Segment Serving:** `stream_manager.py` lines 1546-1558

```python
# If the segment is a local file generated by an HLS transcoder, read from disk
if segment_url.startswith('file://') or os.path.exists(segment_url):
    # Strip file:// prefix if present
    path = segment_url[7:] if segment_url.startswith('file://') else segment_url
    # path = "/hls_temp/m3u_proxy_hls_abc123_xyz/segment_000.ts"

    # Stream the file contents
    with open(path, 'rb') as fh:
        while True:
            chunk = fh.read(32768)
            if not chunk:
                break
            yield chunk
```

‚ùå **THIS IS WHERE IT FAILS!**

---

## üî• **THE ROOT CAUSE**

### **URL Mismatch Between Rewriter and API Endpoint**

**M3U8Processor Rewrites Segments To:** (line 152 in `stream_manager.py`)

```python
return f"{base_proxy_url}/segment.ts?url={encoded_url}&client_id={self.client_id}"
```

**Actual API Endpoint:** (line 749 in `api.py`)

```python
@app.get("/hls/{stream_id}/segment")
```

**The Problem:**

-   **Rewritten URL:** `http://yourip/m3u-proxy/hls/abc123/segment.ts?url=...`
-   **Expected URL:** `http://yourip/m3u-proxy/hls/abc123/segment?url=...`

**The `.ts` extension causes a 404 error!**

When the video player requests segments, it gets:

```
GET /m3u-proxy/hls/abc123/segment.ts?url=file%3A%2F%2F%2Fhls_temp%2F...
‚Üí 404 Not Found (no route matches /hls/{stream_id}/segment.ts)
```

Instead of:

```
GET /m3u-proxy/hls/abc123/segment?url=file%3A%2F%2F%2Fhls_temp%2F...
‚Üí 200 OK (matches /hls/{stream_id}/segment)
```

---

## ‚úÖ **THE FIX**

**File:** `../m3u-proxy-dev/src/stream_manager.py`
**Line:** 152

**Change:**

```python
# BEFORE (WRONG):
return f"{base_proxy_url}/segment.ts?url={encoded_url}&client_id={self.client_id}"

# AFTER (CORRECT):
return f"{base_proxy_url}/segment?url={encoded_url}&client_id={self.client_id}"
```

**Impact:**

-   ‚úÖ Segment URLs will match the actual API endpoint
-   ‚úÖ Player will successfully fetch segments
-   ‚úÖ Video and audio will play correctly

---

## üéØ **VERIFICATION STEPS**

After applying the fix:

1. **Check rewritten playlist URLs:**

    ```bash
    docker exec m3ua-hektic curl -s "http://localhost:8085/hls/{stream_id}/playlist.m3u8?client_id=test" | grep segment
    ```

    Should show: `/segment?url=` (NOT `/segment.ts?url=`)

2. **Test segment request:**

    ```bash
    docker exec m3ua-hektic curl -I "http://localhost:8085/hls/{stream_id}/segment?url=file%3A%2F%2F%2Fhls_temp%2F...&client_id=test"
    ```

    Should return: `200 OK` (NOT `404 Not Found`)

3. **Check browser developer tools:**
    - Network tab should show successful segment requests (200 OK)
    - No 404 errors on segment URLs
    - Video should play with audio

---

## üìù **SUMMARY**

**Issue:** HLS streams load but don't play (black screen with loading spinner)

**Root Cause:** M3U8Processor rewrites segment URLs with `.ts` extension that doesn't match the API endpoint path

**Solution:** Remove `.ts` extension from segment URL rewriting

**Files to Change:** `../m3u-proxy-dev/src/stream_manager.py` (1 line change)

**Severity:** CRITICAL - Prevents all HLS playback

**Complexity:** TRIVIAL - Single character removal

**Testing:** Immediate - Play any HLS stream after fix
